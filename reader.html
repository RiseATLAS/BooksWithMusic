<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Reading - BooksWithMusic</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- iOS Web App Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BooksWithMusic">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="reader-view">
        <!-- Main content area (full viewport height) -->
        <div class="reader-container">
            <aside id="chapter-nav" class="chapter-sidebar hidden">
                <h3>Chapters</h3>
                <div id="chapter-list" class="chapter-list"></div>
            </aside>

            <main id="reader-content" class="reader-content">
                <!-- Chapter content will be dynamically loaded here -->
            </main>
        </div>
        
        <!-- Navigation controls overlay with all buttons -->
        <div class="reader-controls">
            <!-- Top-left controls -->
            <div class="top-left-controls">
                <button id="back-to-library" class="btn btn-icon" title="Back to Library">
                    <span class="icon">‚Üê</span>
                </button>
                <button id="toggle-chapters" class="btn btn-icon" title="Toggle Chapters">
                    <span class="icon">‚ò∞</span>
                </button>
            </div>
            
            <!-- Top-right controls -->
            <div class="top-right-controls">
                <!-- Authentication UI -->
                <div id="auth-container-reader" class="auth-container-reader">
                    <!-- Sign In Button (shown when not authenticated) -->
                    <button id="sign-in-btn-reader" class="btn btn-icon auth-btn-reader hidden" title="Sign In">
                        <span class="icon">üë§</span>
                    </button>
                    
                    <!-- User Profile (shown when authenticated) -->
                    <button id="user-profile-reader" class="btn btn-icon user-profile-btn hidden" title="">
                        <span class="icon">G</span>
                    </button>
                    
                    <!-- User Menu Dropdown -->
                    <div id="user-menu" class="user-menu">
                        <div class="user-menu-header">
                            <div class="user-menu-icon">G</div>
                            <div class="user-menu-info">
                                <div id="user-menu-name" class="user-menu-name"></div>
                                <div id="user-menu-email" class="user-menu-email"></div>
                            </div>
                        </div>
                        <div class="user-menu-divider"></div>
                        <button id="sign-out-btn-reader" class="user-menu-item">
                            <span class="icon">üö™</span> Sign Out
                        </button>
                    </div>
                </div>
                
                <button id="fullscreen-btn" class="btn btn-icon" title="Fullscreen - Press F or F11 to toggle">
                    <span class="icon">‚õ∂</span>
                </button>
                <button id="settings-btn" class="btn btn-icon" title="Settings">
                    <span class="icon">‚öô</span>
                </button>
                <button id="music-settings-toggle" class="btn btn-icon" title="Music Settings">
                    <span class="icon">üéµ‚öô</span>
                </button>
                <button id="music-toggle" class="btn btn-icon" title="Music">
                    <span class="icon">‚ô´</span>
                </button>
            </div>
            
            <!-- Side navigation -->
            <button id="prev-chapter" class="btn btn-secondary">‚Üê</button>
            <button id="next-chapter" class="btn btn-secondary">‚Üí</button>
        </div>
    </div>

    <!-- Music Panel -->
    <div id="music-panel" class="music-panel">
        <div class="music-header">
            <h3>Music</h3>
            <div id="playback-source-status" class="playback-source-status status-info">
                Freesound selected - ready
            </div>
        </div>

        <div class="music-playlist-header">
            <h4>Playlist</h4>
            <div id="next-shift-info" class="next-shift-info hidden"></div>
        </div>

        <div class="music-controls music-controls-inline">
            <button id="prev-track" class="btn btn-icon" title="Previous Track">
                <span class="icon">‚èÆ</span>
            </button>
            <button id="play-pause" class="btn btn-icon btn-large" title="Play/Pause - Press P to toggle">
                <span class="icon">‚ñ∂</span>
            </button>
            <button id="next-track" class="btn btn-icon" title="Next Track">
                <span class="icon">‚è≠</span>
            </button>
            
            <!-- Volume control inline with playback buttons -->
            <div class="volume-control-inline">
                <span class="icon">‚ô™</span>
                <input type="range" id="volume-slider" min="0" max="100" value="70" title="Volume">
                <span id="volume-value">70%</span>
            </div>
        </div>

        <div class="playlist">
            <div id="playlist-tracks" class="playlist-tracks"></div>
        </div>
    </div>

    <!-- Music Settings Panel (separate from music player) -->
    <div id="music-settings-panel" class="music-settings-panel">
        <div class="settings-header">
            <h3>Music Settings</h3>
        </div>

        <div class="settings-content">
            <!-- Two Column Layout -->
            <div class="settings-two-column">
                <!-- Left Column: Music Controls & Behavior -->
                <div class="settings-column">
                    <h4 class="settings-section-title">Music Controls</h4>

                    <div class="setting-group">
                        <label for="music-enabled-panel">
                            <input type="checkbox" id="music-enabled-panel" checked>
                            Enable Background Music
                        </label>
                    </div>

                    <div class="setting-group">
                        <label for="auto-play-panel">
                            <input type="checkbox" id="auto-play-panel">
                            Auto-play Music
                        </label>
                    </div>

                    <div class="setting-group">
                        <label for="page-based-music-switch">
                            <input type="checkbox" id="page-based-music-switch" checked>
                            Dynamic Page-Based Switching (auto mood shifts)
                        </label>
                        <small class="music-setting-explanation">
                            Switches tracks when the story's mood changes mid-chapter.
                        </small>
                    </div>

                    <div class="setting-group" data-music-provider="spotify">
                        <label for="instrumental-only">
                            <input type="checkbox" id="instrumental-only" checked>
                            Background Music Only (instrumental/ambient)
                        </label>
                        <small class="music-setting-explanation">
                            Filters out tracks with vocals for distraction-free reading.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="verbose-logging">
                            <input type="checkbox" id="verbose-logging" checked>
                            Detailed Music Logs (Console)
                        </label>
                        <small class="music-setting-explanation">
                            Show detailed analysis in browser console. Disable for cleaner logs.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="show-track-info">
                            <input type="checkbox" id="show-track-info">
                            Show Track Details
                        </label>
                        <small class="music-setting-explanation">
                            Display why each track was chosen, its genre, energy level, and intended mood/scene.
                        </small>
                    </div>

                    <h4 class="settings-section-title">Music Source</h4>

                    <div class="setting-group">
                        <label for="music-source-select">Music Provider</label>
                        <select id="music-source-select" class="music-source-select">
                            <option value="freesound">üÜì Freesound (Free, CC0)</option>
                            <option value="spotify">üé∂ Spotify (Premium Required)</option>
                        </select>
                        <small class="music-setting-explanation">
                            Freesound: Free, offline-capable, embedded player<br>
                            Spotify: 100M+ tracks, requires Premium, external player
                        </small>
                    </div>

                    <div id="spotify-auth-section" class="setting-group" style="display: none;" data-music-provider="spotify">
                        <button id="spotify-connect-btn" class="btn btn-primary">
                            <span class="icon">üîê</span> Connect Spotify
                        </button>
                        <button id="spotify-disconnect-btn" class="btn btn-secondary" style="display: none;">
                            <span class="icon">üîì</span> Disconnect Spotify
                        </button>
                        <div id="spotify-status" class="spotify-status">
                            <span id="spotify-status-text">Not connected</span>
                        </div>
                        <small class="music-setting-explanation">
                            ‚ö†Ô∏è Requires Spotify Premium and active device (desktop/mobile/web player)
                        </small>
                    </div>

                    <h4 class="settings-section-title">Playlist Settings</h4>

                    <div class="setting-group" data-music-provider="spotify">
                        <label for="max-energy-level">
                            Maximum Energy Level (1=calm, 5=intense)
                        </label>
                        <input type="range" id="max-energy-level" min="1" max="5" step="1" value="3">
                        <span id="max-energy-value">3 (Moderate)</span>
                        <small class="music-setting-explanation">
                            Lower = more peaceful, higher = more epic/intense allowed.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="songs-per-chapter">
                            Songs per Chapter
                        </label>
                        <input type="range" id="songs-per-chapter" min="1" max="20" step="1" value="5">
                        <span id="songs-per-chapter-value">5 songs</span>
                        <small class="music-setting-explanation">
                            ‚ÑπÔ∏è Songs are weighted by mood match: Best matches play more often, ensuring variety while staying true to the chapter's atmosphere.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="min-songs-per-pages">
                            Minimum Songs per Pages
                        </label>
                        <input type="range" id="min-songs-per-pages" min="1" max="10" step="1" value="1">
                        <span id="min-songs-per-pages-value">1 song per 1 page</span>
                        <small class="music-setting-explanation">
                            Longer chapters get more songs automatically.
                        </small>
                    </div>

                    <div class="setting-group" data-music-provider="freesound">
                        <label for="crossfade-duration-panel">Crossfade Duration</label>
                        <input type="range" id="crossfade-duration-panel" min="1" max="10" value="3">
                        <span id="crossfade-value-panel">3s</span>
                        <small class="music-setting-explanation">
                            Longer for seamless flow, shorter for distinct changes.
                        </small>
                    </div>
                </div>

                <!-- Right Column: Music Customization & API -->
                <div class="settings-column">
                    <h4 class="settings-section-title">Music Customization</h4>

                    <div class="setting-group">
                        <label for="book-vibe-keywords">
                            Book Vibe Keywords <small class="label-hint">(comma-separated)</small>
                        </label>
                        <input type="text" id="book-vibe-keywords" placeholder="e.g., fantasy, epic, orchestral, cinematic">
                        
                        <!-- Auto-detected keywords display -->
                        <div id="auto-detected-keywords" class="auto-detected-keywords hidden">
                            <small class="auto-detected-label">üìö Auto-detected from book:</small>
                            <div id="auto-detected-keywords-list" class="auto-detected-list"></div>
                        </div>
                        
                        <small class="music-setting-explanation">
                            üé≠ <strong>Influence the entire book's musical atmosphere!</strong><br>
                            Add keywords to shape music selection across all chapters. Examples: "fantasy, epic" for high fantasy, "noir, jazz" for detective stories, "ambient, space" for sci-fi.<br>
                            <span class="setting-note">Leave empty to use auto-detected keywords shown above. Enter your own to override.</span>
                        </small>
                        <button id="apply-book-vibe" class="btn btn-primary save-key-button">Apply & Reanalyze</button>
                    </div>

                    <h4 class="settings-section-title">Music API</h4>

                    <div class="setting-group" data-music-provider="freesound">
                        <label for="freesound-key-panel">Freesound API Key</label>
                        <input type="text" id="freesound-key-panel" placeholder="Enter your API key">
                        <button id="save-freesound-key-panel" class="btn btn-primary save-key-button">Save Key</button>
                        
                        <!-- Backup key status message -->
                        <div id="backup-key-status" class="backup-key-status hidden">
                            <div class="backup-key-status-text">
                                ‚úÖ <strong>Currently using backup key</strong> ‚Äî No need to add your own!
                            </div>
                            <small class="backup-key-status-note">
                                The app is using a built-in backup API key. Music will work without adding your own key.
                            </small>
                        </div>
                        
                        <div id="freesound-key-help" class="freesound-key-help">
                            <strong class="freesound-key-help-title">How to get a free Freesound API key:</strong>
                            <ol>
                                <li>Visit <a href="https://freesound.org/apiv2/apply/" target="_blank" rel="noopener">freesound.org/apiv2/apply</a></li>
                                <li>Create a free Freesound account (or sign in)</li>
                                <li>Fill out the API application form</li>
                                <li>You'll receive your API key instantly</li>
                                <li>Paste the key above and click "Save Key"</li>
                            </ol>
                            <small class="freesound-key-help-note">
                                ‚ÑπÔ∏è Freesound is a free, community-driven database of Creative Commons licensed sounds. 
                                The API key is completely free and allows you to access thousands of high-quality music tracks.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-header">
            <h3>Settings</h3>
        </div>

        <div class="settings-content">
            <!-- Two Column Layout -->
            <div class="settings-two-column">
                <!-- Left Column: Text & Reading -->
                <div class="settings-column">
                    <h4 class="settings-section-title">Text & Reading</h4>
                    
                    <div class="setting-group">
                        <label for="font-size">Font Size</label>
                        <input type="range" id="font-size" min="12" max="34" value="18">
                        <span id="font-size-value">18px</span>
                        <small class="music-setting-explanation">
                            Larger sizes are easier on eyes, smaller fits more text per page.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="line-height">Line Height</label>
                        <input type="range" id="line-height" min="1.2" max="2.0" step="0.1" value="1.6">
                        <span id="line-height-value">1.6</span>
                        <small class="music-setting-explanation">
                            Higher values improve readability, lower fits more text on screen.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="font-family">Font Family</label>
                        <select id="font-family">
                            <option value="serif" selected>Serif (Georgia)</option>
                            <option value="sans-serif">Sans-serif (System)</option>
                            <option value="monospace">Monospace (Courier)</option>
                            <option value="open-dyslexic">OpenDyslexic</option>
                        </select>
                        <small class="music-setting-explanation">
                            Serif for traditional feel, OpenDyslexic for dyslexia support.
                        </small>
                    </div>

                    <h4 class="settings-section-title">Page Layout</h4>

                    <div class="setting-group">
                        <label for="text-width">Text Width</label>
                        <input type="range" id="text-width" min="10" max="100" step="5" value="100">
                        <span id="text-width-value">100%</span>
                        <small class="music-setting-explanation">
                            Control line length: narrower (60-80%) for easier reading, wider (90-100%) for more content.
                        </small>
                    </div>
                </div>

                <!-- Right Column: Appearance & Display -->
                <div class="settings-column">
                    <h4 class="settings-section-title">Appearance</h4>

                    <div class="setting-group">
                        <label for="theme-select">Theme</label>
                        <select id="theme-select">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="sepia" selected>Sepia</option>
                        </select>
                        <small class="music-setting-explanation">
                            Light for daytime, dark for night, sepia for warmth.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="page-color">Page Color</label>
                        <select id="page-color">
                            <option value="white">White</option>
                            <option value="cream" selected>Cream</option>
                            <option value="gray">Gray</option>
                            <option value="black">Black</option>
                        </select>
                        <small class="music-setting-explanation">
                            Cream reduces eye strain, black for dark mode.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="brightness">Brightness</label>
                        <input type="range" id="brightness" min="60" max="120" value="100">
                        <span id="brightness-value">100%</span>
                        <small class="music-setting-explanation">
                            Lower for night reading, higher for bright environments.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label for="page-warmth">Page Warmth</label>
                        <input type="range" id="page-warmth" min="0" max="100" value="10">
                        <span id="page-warmth-value">10%</span>
                        <small class="music-setting-explanation">
                            Adds amber tone to reduce blue light.
                        </small>
                    </div>

                    <h4 class="settings-section-title">Display Options</h4>

                    <div class="setting-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-book-page-count" checked>
                            <span>Book Page Count (Current / Total)</span>
                        </label>
                        <small class="music-setting-explanation">
                            E.g., "Book Page: 45 / 200"
                        </small>
                    </div>

                    <div class="setting-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-book-progress" checked>
                            <span>Book Progress Percentage (Clickable)</span>
                        </label>
                        <small class="music-setting-explanation">
                            Click to jump to any % in the book.
                        </small>
                    </div>

                    <div class="setting-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-chapter-page-count" checked>
                            <span>Chapter Page Count (Current / Total)</span>
                        </label>
                        <small class="music-setting-explanation">
                            E.g., "Chapter Page: 3 / 12"
                        </small>
                    </div>

                    <div class="setting-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-chapter-count" checked>
                            <span>Chapter Position (Current / Total)</span>
                        </label>
                        <small class="music-setting-explanation">
                            E.g., "Chapter: 5 / 20"
                        </small>
                    </div>

                    <!-- iOS Fullscreen Tip (only shown on iOS) -->
                    <div id="ios-fullscreen-tip" class="setting-group ios-fullscreen-tip hidden">
                        <h4>üì± iOS Fullscreen Experience</h4>
                        <p>
                            For the best fullscreen reading experience on iPhone/iPad:
                        </p>
                        <ol>
                            <li><strong>Add to Home Screen:</strong> Tap Share (‚ñ°‚Üë) ‚Üí "Add to Home Screen"</li>
                            <li><strong>Launch from Home:</strong> Open the app from your home screen icon</li>
                            <li><strong>Hide Controls:</strong> Tap the text area to hide/show all buttons</li>
                        </ol>
                        <p class="tip-note">
                            ‚ÑπÔ∏è iOS Safari doesn't support fullscreen mode, but adding to home screen gives you a native app-like experience!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p id="loading-message">Loading...</p>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Load TextLayoutEngine first (non-module script) -->
    <script src="js/core/text-layout-engine.js"></script>
    
    <!-- Then load app modules -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
