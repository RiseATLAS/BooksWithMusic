import S from"https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm";import{F as _}from"./firebase-manager-DnXBgpu9.js";class B{async parse(e){return this.parseEPUB(e)}async parseEPUB(e){const t=await S.loadAsync(e),a=await this._getContainerXML(t),s=this._getOPFPath(a),r=await this._getOPF(t,s),n=this._extractMetadata(r),o=this._extractSpine(r),i=this._extractManifest(r),c=await this._extractImages(t,i,s),l=await this._extractCoverImage(t,r,i,s,c),h=await this._extractChapters(t,o,i,s,c);return{id:this._generateId(),title:n.title||"Untitled Book",author:n.author||"Unknown Author",chapters:h,images:c,coverImage:l,metadata:{language:n.language,publisher:n.publisher,publishDate:n.date,description:n.description},addedDate:new Date().toISOString(),currentChapter:0,currentPage:0}}async _getContainerXML(e){const t=e.file("META-INF/container.xml");if(!t)throw new Error("Invalid EPUB: container.xml not found");return await t.async("text")}_getOPFPath(e){const s=new DOMParser().parseFromString(e,"text/xml").querySelector("rootfile");if(!s)throw new Error("Invalid EPUB: rootfile not found");return s.getAttribute("full-path")||""}async _getOPF(e,t){const a=e.file(t);if(!a)throw new Error("Invalid EPUB: OPF file not found");const s=await a.async("text");return new DOMParser().parseFromString(s,"text/xml")}_extractMetadata(e){var s,r,n,o,i,c,l,h,u,g,p,m;const t={},a=e.querySelector("metadata");if(a){t.title=((r=(s=a.querySelector("title"))==null?void 0:s.textContent)==null?void 0:r.trim())||"";let y="";const f=a.querySelector("creator");if(f&&(y=((n=f.textContent)==null?void 0:n.trim())||""),!y){const k=a.querySelector('dc\\:creator, creator[xmlns*="dublin"]');k&&(y=((o=k.textContent)==null?void 0:o.trim())||"")}t.author=y,t.language=((c=(i=a.querySelector("language"))==null?void 0:i.textContent)==null?void 0:c.trim())||"",t.publisher=((h=(l=a.querySelector("publisher"))==null?void 0:l.textContent)==null?void 0:h.trim())||"",t.date=((g=(u=a.querySelector("date"))==null?void 0:u.textContent)==null?void 0:g.trim())||"",t.description=((m=(p=a.querySelector("description"))==null?void 0:p.textContent)==null?void 0:m.trim())||""}return t}_extractSpine(e){const t=e.querySelector("spine");return t?Array.from(t.querySelectorAll("itemref")).map(a=>a.getAttribute("idref")||""):[]}_extractManifest(e){const t=new Map,a=e.querySelector("manifest");return a&&Array.from(a.querySelectorAll("item")).forEach(s=>{const r=s.getAttribute("id"),n=s.getAttribute("href");r&&n&&t.set(r,n)}),t}async _extractChapters(e,t,a,s,r){const n=[],o=s.substring(0,s.lastIndexOf("/")+1);for(let i=0;i<t.length;i++){const c=t[i],l=a.get(c);if(l){const h=o+l,u=e.file(h);if(u){const g=await u.async("text"),p=this._processImagesInContent(g,r,o),m=this._extractChapterTitle(g)||`Chapter ${i+1}`;n.push({id:this._generateId(),title:m,content:p,order:i})}}}return n}_cleanHTML(e){const a=new DOMParser().parseFromString(e,"text/html");a.querySelectorAll("script, style").forEach(r=>r.remove());const s=a.querySelector("body");return(s==null?void 0:s.innerHTML)||e}_extractChapterTitle(e){var r;const s=new DOMParser().parseFromString(e,"text/html").querySelector("h1, h2, h3");return((r=s==null?void 0:s.textContent)==null?void 0:r.trim())||""}_generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}async _extractImages(e,t,a){const s=new Map,r=a.substring(0,a.lastIndexOf("/")+1);for(const[n,o]of t){const i=r+o,c=e.file(i);if(c&&this._isImageFile(o))try{const l=await c.async("base64"),u=`data:${this._guessMimeType(o)};base64,${l}`;s.set(o,u),s.set(i,u),s.set(n,u)}catch(l){console.warn(`Failed to extract image ${o}:`,l)}}return s}async _extractCoverImage(e,t,a,s,r){s.substring(0,s.lastIndexOf("/")+1);const n=t.querySelector("metadata");if(n){const i=n.querySelector('meta[name="cover"]');if(i){const c=i.getAttribute("content");if(r.has(c))return r.get(c)}}const o=["cover.jpg","cover.png","Cover.jpg","Cover.png","images/cover.jpg","images/cover.png","Images/cover.jpg","Images/cover.png","OEBPS/images/cover.jpg","OEBPS/images/cover.png"];for(const i of o){const c=e.file(i);if(c)try{const l=await c.async("base64");return`data:${this._guessMimeType(i)};base64,${l}`}catch(l){console.warn(`Failed to load cover from ${i}:`,l)}}for(const[i,c]of a)if(c.toLowerCase().includes("cover")&&this._isImageFile(c)&&r.has(i))return r.get(i);return null}_guessMimeType(e){const t=(e||"").toLowerCase();return t.endsWith(".png")?"image/png":t.endsWith(".gif")?"image/gif":t.endsWith(".svg")?"image/svg+xml":t.endsWith(".webp")?"image/webp":t.endsWith(".bmp")?"image/bmp":t.endsWith(".jpeg")||t.endsWith(".jpg")?"image/jpeg":"application/octet-stream"}async extractCoverOnly(e){const t=await S.loadAsync(e),a=await this._getContainerXML(t),s=this._getOPFPath(a),r=await this._getOPF(t,s),n=this._extractManifest(r),o=await this._extractImages(t,n,s);return{coverImage:await this._extractCoverImage(t,r,n,s,o)}}_isImageFile(e){const t=[".jpg",".jpeg",".png",".gif",".svg",".webp",".bmp"],a=e.toLowerCase();return t.some(s=>a.endsWith(s))}_processImagesInContent(e,t,a){const r=new DOMParser().parseFromString(e,"text/html");r.querySelectorAll("script, style").forEach(o=>o.remove()),r.querySelectorAll("img").forEach(o=>{const i=o.getAttribute("src");if(i){let c=null;if(t.has(i))c=t.get(i);else{const l=this._resolvePath(a,i);if(t.has(l))c=t.get(l);else{const h=i.replace(/^\.?\//,"");t.has(h)&&(c=t.get(h))}}c?(o.setAttribute("src",c),o.setAttribute("style","max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);")):(console.warn(`Image not found: ${i}`),o.setAttribute("alt",`[Image: ${i}]`),o.setAttribute("style","display: none;"))}});const n=r.querySelector("body");return(n==null?void 0:n.innerHTML)||r.documentElement.innerHTML}_resolvePath(e,t){const a=t.replace(/^\.?\//,"");return e+a}}class I{constructor(){this.moodKeywords={dark:["dark","shadow","night","death","fear","terror","horror","nightmare","evil","sinister","grim","haunted","ominous","doom","dread","foreboding","ghastly","macabre","menace","sinister","bleak","murky","obscure","dim","gloomy","dismal","black","twilight","abyss","void","cursed","wicked","malevolent","diabolical"],mysterious:["mystery","secret","hidden","unknown","enigma","puzzle","strange","curious","cryptic","obscure","arcane","esoteric","riddle","cipher","veiled","shadowy","elusive","ambiguous","perplexing","baffling","mystifying","intrigue","conspiracy","covert","clandestine","whisper","clue","investigate","probe"],romantic:["love","heart","kiss","romance","passion","desire","affection","tender","embrace","caress","intimate","adore","cherish","devoted","sweetheart","beloved","longing","yearning","amorous","enchanted","smitten","enamored","infatuated","crush","flutter","blush","gentle touch","gaze","whisper"],sad:["sad","tear","cry","grief","sorrow","loss","melancholy","lonely","despair","mourn","weep","anguish","heartbreak","misery","woe","lament","regret","remorse","bitter","forlorn","desolate","empty","hopeless","depressed","downcast","crestfallen","dejected","somber","mournful","wistful"],epic:["battle","war","fight","hero","victory","triumph","glory","legend","conquest","valor","courage","brave","warrior","champion","clash","siege","army","combat","duel","sword","shield","charge","assault","defend","fortress","kingdom","empire","destiny","fate","prophecy","epic","grand","mighty","powerful"],peaceful:["peace","calm","quiet","gentle","soft","serene","tranquil","rest","still","placid","soothing","harmonious","relaxed","content","ease","comfort","silence","hush","meditation","contemplation","breeze","meadow","garden","stream","dawn","sunset","twilight","lullaby","whisper"],tense:["danger","threat","tension","suspense","anxiety","worry","nervous","alert","urgent","panic","alarm","warning","crisis","peril","risk","hazard","jeopardy","precarious","uncertain","edge","brink","pressure","strain","stress","chase","pursue","flee","escape","trap","cornered"],joyful:["happy","joy","laugh","smile","cheer","delight","merry","celebration","jubilant","ecstatic","elated","gleeful","festive","exuberant","radiant","blissful","thrilled","excited","euphoric","jovial","cheerful","bright","sunny","playful","grin","giggle","dance","sing","rejoice"],adventure:["journey","quest","explore","discover","travel","adventure","expedition","voyage","trek","wander","roam","pioneer","frontier","horizon","path","trail","map","compass","uncharted","wild","wilderness","mountain","sea","forest","cave","treasure","seek","search","brave","bold"],magical:["magic","spell","wizard","witch","enchant","mystical","supernatural","sorcery","conjure","incantation","potion","wand","charm","hex","rune","ritual","ethereal","otherworldly","fairy","dragon","phoenix","unicorn","mythical","legendary","arcane","divine","celestial","enchanted","bewitched","spellbound"]},this.moodToMusicMapping={dark:{tags:["dark","atmospheric","tense"],energy:4,tempo:"slow"},mysterious:{tags:["mysterious","ambient","ethereal"],energy:3,tempo:"moderate"},romantic:{tags:["romantic","gentle","classical"],energy:2,tempo:"slow"},sad:{tags:["melancholy","piano","emotional"],energy:2,tempo:"slow"},epic:{tags:["epic","orchestral","dramatic"],energy:5,tempo:"upbeat"},peaceful:{tags:["calm","peaceful","nature"],energy:1,tempo:"slow"},tense:{tags:["suspenseful","intense","dramatic"],energy:4,tempo:"moderate"},joyful:{tags:["uplifting","cheerful","bright"],energy:4,tempo:"upbeat"},adventure:{tags:["adventurous","energetic","inspiring"],energy:4,tempo:"upbeat"},magical:{tags:["mystical","ethereal","ambient"],energy:3,tempo:"moderate"}}}async analyzeBook(e){console.log(`AI Processor: Analyzing book "${e.title}" with ${e.chapters.length} chapters...`);const t=e.chapters.map((s,r)=>{const n=this.analyzeChapter(s,e);return console.log(`Chapter ${r+1} (${s.title}): ${n.primaryMood} - Energy: ${n.energy}/5`),n});return{bookProfile:this._generateBookProfile(e,t),chapterAnalyses:t,generatedAt:new Date().toISOString()}}analyzeChapter(e,t){var l,h;const a=`${e.title} ${e.content}`.toLowerCase(),s={};for(const[u,g]of Object.entries(this.moodKeywords)){let p=0;for(const m of g){const y=new RegExp(`\\b${m}\\w*\\b`,"gi"),f=a.match(y);p+=f?f.length:0}s[u]=p}const r=Object.entries(s).sort((u,g)=>g[1]-u[1]).filter(([u,g])=>g>0),n=((l=r[0])==null?void 0:l[0])||"peaceful",o=(h=r[1])==null?void 0:h[0],i=this.moodToMusicMapping[n]||this.moodToMusicMapping.peaceful,c=[...i.tags];return o&&this.moodToMusicMapping[o]&&c.push(...this.moodToMusicMapping[o].tags.slice(0,1)),{chapterId:e.id||e.title,chapterTitle:e.title,primaryMood:n,secondaryMood:o,moodScores:s,musicTags:[...new Set(c)],energy:i.energy,tempo:i.tempo,recommendedGenres:this._getGenresForMood(n)}}_generateBookProfile(e,t){var c,l;const a=e.title.toLowerCase(),s={};let r=0;t.forEach(h=>{s[h.primaryMood]=(s[h.primaryMood]||0)+1,r+=h.energy});const n=((c=Object.entries(s).sort((h,u)=>u[1]-h[1])[0])==null?void 0:c[0])||"peaceful",o=Math.round(r/t.length);let i=null;for(const[h,u]of Object.entries(this.moodKeywords))if(u.some(g=>a.includes(g))){i=h;break}return{title:e.title,dominantMood:n,titleMood:i||n,averageEnergy:o,moodDistribution:s,recommendedTags:((l=this.moodToMusicMapping[n])==null?void 0:l.tags)||["ambient","calm"],tempo:o>3?"upbeat":o>2?"moderate":"slow"}}_getGenresForMood(e){return{dark:["dark ambient","atmospheric","drone"],mysterious:["ambient","electronic","minimal"],romantic:["classical","piano","strings"],sad:["piano","classical","acoustic"],epic:["orchestral","cinematic","epic"],peaceful:["ambient","nature sounds","meditation"],tense:["suspense","electronic","minimal"],joyful:["uplifting","indie","folk"],adventure:["orchestral","world music","energetic"],magical:["fantasy","ambient","ethereal"]}[e]||["instrumental","ambient"]}selectTrackForChapter(e,t){var s;if(!t||t.length===0)return null;const a=t.map(r=>{let n=0;const o=r.tags||[];if((e.musicTags||[]).forEach(c=>{o.some(l=>l.includes(c)||c.includes(l))&&(n+=3)}),r.energy){const c=Math.abs(r.energy-e.energy);n+=5-c}return r.tempo&&r.tempo===e.tempo&&(n+=2),{track:r,score:n}});return a.sort((r,n)=>n.score-r.score),((s=a[0])==null?void 0:s.track)||t[0]}selectTracksForChapter(e,t,a){var c;if(!t||t.length===0)return[];const s=((c=a.content)==null?void 0:c.split(/\s+/).length)||1e3;let r;s<2e3?r=1:s<5e3?r=2:s<8e3?r=3:s<12e3?r=4:r=5,console.log(`   Chapter "${a.title}": ${s} words ‚Üí ${r} tracks`);const n=t.map(l=>{let h=0;const u=l.tags||[];if((e.musicTags||[]).forEach(p=>{u.some(m=>m.includes(p)||p.includes(m))&&(h+=3)}),l.energy){const p=Math.abs(l.energy-e.energy);h+=5-p}return l.tempo&&l.tempo===e.tempo&&(h+=2),{track:l,score:h}});n.sort((l,h)=>h.score-l.score);const o=Math.min(r,n.length);return n.slice(0,o).map(l=>l.track)}generateChapterMappings(e,t,a){return t.map((s,r)=>{const n=e.chapters[r],o=this.selectTracksForChapter(s,a,n);return{bookId:e.id,chapterId:s.chapterId,chapterTitle:s.chapterTitle,primaryMood:s.primaryMood,tracks:o.map(i=>({trackId:i.id,trackTitle:i.title,trackUrl:i.url,trackArtist:i.artist,trackDuration:i.duration})),trackCount:o.length,reasoning:`${s.primaryMood} mood detected, energy: ${s.energy}/5, ${o.length} tracks selected`}})}}class A{constructor(e){this.db=e,this.parser=new B,this.aiProcessor=new I,this.eventHandlers={}}async initialize(){console.log("Initializing library..."),this.setupImportButton(),console.log("Import button setup complete");try{await this.loadBooks(),console.log("Books loaded")}catch(e){console.error("Error loading books:",e)}}setupImportButton(){const e=document.getElementById("import-book"),t=document.getElementById("file-input");e==null||e.addEventListener("click",()=>t==null?void 0:t.click()),t==null||t.addEventListener("change",async a=>{const s=a.target.files[0];s&&s.name.endsWith(".epub")&&(await this.importBook(s),t.value="")})}async importBook(e){var t,a;try{this.showLoading("Importing book...");const s=await e.arrayBuffer(),r=await this.parser.parse(s),n=r.chapters.reduce((h,u)=>{const g=u.content.replace(/<[^>]*>/g,"");return h+g.split(/\s+/).filter(p=>p.length>0).length},0),o={title:((t=r.metadata)==null?void 0:t.title)||e.name.replace(".epub",""),author:((a=r.metadata)==null?void 0:a.author)||"Unknown Author",data:s,coverImage:r.coverImage,importDate:new Date,progress:0,currentChapter:0,totalWords:n},i=await this.db.saveBook(o);console.log("ü§ñ Analyzing book with AI...");const c={id:i,title:o.title,chapters:r.chapters},l=await this.aiProcessor.analyzeBook(c);await this.db.saveAnalysis(i,l),console.log("‚úì AI analysis saved to database"),this.hideLoading(),this.showToast("Book imported successfully!"),await this.loadBooks()}catch(s){console.error("Error importing book:",s),this.hideLoading(),this.showToast("Error importing book","error")}}async loadBooks(){const e=await this.db.getAllBooks();this.renderBooks(e)}renderBooks(e){const t=document.getElementById("book-list");if(!t)return;if(e.length===0){t.innerHTML=`
        <div class="empty-state">
          <p>üìö No books yet</p>
          <p class="subtitle">Import an EPUB to get started</p>
        </div>
      `;return}t.innerHTML=e.map(s=>{const r=Math.ceil((s.totalWords||5e4)/250),n=Math.floor((s.progress||0)/100*r),o=s.coverImage?`<img src="${s.coverImage}" alt="Book cover" class="book-cover-image">`:'<div class="book-cover-placeholder">üìñ</div>';return`
        <div class="book-card" data-book-id="${s.id}">
          <div class="book-cover">${o}</div>
          <h3 class="book-title">${this.escapeHtml(s.title)}</h3>
          <p class="book-author">${this.escapeHtml(s.author)}</p>
          <div class="book-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${s.progress||0}%"></div>
            </div>
            <span class="progress-text">Page ${n} of ${r}</span>
          </div>
          <div class="book-actions">
            <button class="btn btn-primary btn-read" data-book-id="${s.id}">Read</button>
            <button class="btn btn-secondary btn-delete" data-book-id="${s.id}">Delete</button>
          </div>
        </div>
      `}).join("");const a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("click",async s=>{const r=s.target.closest(".btn-read");if(r){s.preventDefault(),s.stopPropagation();const o=r.dataset.bookId;this.emit("bookSelected",o);return}const n=s.target.closest(".btn-delete");if(n){s.preventDefault(),s.stopPropagation();const o=n.dataset.bookId;confirm("Are you sure you want to delete this book?")&&await this.deleteBook(o);return}})}async deleteBook(e){try{await this.db.deleteBook(e),this.showToast("Book deleted"),await this.loadBooks()}catch(t){console.error("Error deleting book:",t),this.showToast("Error deleting book","error")}}on(e,t){this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t)}emit(e,t){this.eventHandlers[e]&&this.eventHandlers[e].forEach(a=>a(t))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showLoading(e){const t=document.getElementById("loading-overlay"),a=document.getElementById("loading-message");t&&a&&(a.textContent=e,t.classList.remove("hidden"))}hideLoading(){const e=document.getElementById("loading-overlay");e&&e.classList.add("hidden")}showToast(e,t="success"){const a=document.getElementById("toast-container");if(!a)return;const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,a.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}}class M{constructor(){this.CACHE_NAME="booksWithMusic-audio-v1",this.MAX_CACHE_SIZE=100}async cacheTrack(e,t){if(!("caches"in window))return;const a=await caches.open(this.CACHE_NAME),s=new Response(t,{headers:{"Content-Type":"audio/mpeg"}});await a.put(`/audio/${e}`,s),await this._enforceCacheLimit()}async getCachedTrack(e){if(!("caches"in window))return null;const a=await(await caches.open(this.CACHE_NAME)).match(`/audio/${e}`);return a?await a.blob():null}async isTrackCached(e){return"caches"in window?!!await(await caches.open(this.CACHE_NAME)).match(`/audio/${e}`):!1}async clearCache(){"caches"in window&&await caches.delete(this.CACHE_NAME)}async _enforceCacheLimit(){const e=await caches.open(this.CACHE_NAME),t=await e.keys();if(t.length>this.MAX_CACHE_SIZE){const a=t.slice(0,t.length-this.MAX_CACHE_SIZE);await Promise.all(a.map(s=>e.delete(s)))}}}class L{constructor(){this.freesoundKey=localStorage.getItem("freesound_api_key")||"",this.cache=new Map}isConfigured(){return!!this.freesoundKey}setFreesoundKey(e){this.freesoundKey=e,localStorage.setItem("freesound_api_key",e)}async searchTracks(e,t=10){console.log("üîç MusicAPI: Searching tracks with tags:",e,"limit:",t);const a=`${e.join(",")}_${t}`;if(this.cache.has(a)){const s=this.cache.get(a);return console.log("‚úì Using cached tracks:",s.length),s}try{let s=[];return this.freesoundKey?(console.log("üîë Using Freesound API key"),s=await this.searchFreesound(e,t),console.log("‚úì Freesound returned:",s.length,"tracks")):console.log("‚ö†Ô∏è No API key configured"),s.length===0&&(console.log("üìö Loading fallback tracks..."),s=await this.getFallbackTracks(e,t),console.log("‚úì Fallback tracks:",s.length)),this.cache.set(a,s),console.log("‚úì Total tracks found:",s.length),s}catch(s){console.error("‚ùå Error fetching music:",s);const r=await this.getFallbackTracks(e,t);return console.log("‚úì Emergency fallback tracks:",r.length),r}}async searchFreesound(e,t){if(!this.freesoundKey)return[];const a=e.join(" "),s=`https://freesound.org/apiv2/search/text/?query=${encodeURIComponent(a)}&filter=duration:[30 TO *] tag:music&fields=id,name,username,duration,previews,tags,license&token=${this.freesoundKey}&page_size=${t}`;try{const r=await fetch(s);if(!r.ok)return console.warn("Freesound API error:",r.status),[];const n=await r.json();return console.log("Freesound response:",n.count,"results found"),n.results.map(o=>({id:`freesound_${o.id}`,title:o.name,artist:o.username,duration:Math.round(o.duration),url:o.previews["preview-hq-mp3"]||o.previews["preview-lq-mp3"],tags:o.tags,energy:this._estimateEnergy(o.tags),tempo:this._estimateTempo(o.tags),license:{type:o.license,attributionRequired:!o.license.includes("CC0"),sourceUrl:`https://freesound.org/people/${o.username}/sounds/${o.id}/`,downloadAllowed:!0}}))}catch(r){return console.error("Freesound search failed:",r),[]}}_estimateEnergy(e){const t=["energetic","fast","intense","epic","dramatic","aggressive"],a=["calm","peaceful","slow","ambient","quiet","gentle"],s=e.join(" ").toLowerCase();return t.some(r=>s.includes(r))?4:a.some(r=>s.includes(r))?2:3}_estimateTempo(e){const t=e.join(" ").toLowerCase();return t.match(/fast|upbeat|energetic|quick/)?"upbeat":t.match(/slow|calm|peaceful|gentle/)?"slow":"moderate"}async getFallbackTracks(e,t){return console.log("üìö Note: Using fallback approach. For best experience, add your own music URLs or use a music API."),[]}async getCuratedLibrary(){const e=localStorage.getItem("user_music_tracks");if(e)try{return JSON.parse(e)}catch{console.error("Failed to parse user tracks")}return[]}async downloadTrack(e){try{return await(await fetch(e.url)).blob()}catch(t){return console.error("Error downloading track:",t),null}}async getTracksForMood(e,t=5){const s={dark:["dark","atmospheric","suspense"],mysterious:["mysterious","ambient","ethereal"],romantic:["romantic","piano","emotional"],sad:["sad","melancholy","emotional"],epic:["epic","orchestral","cinematic"],peaceful:["calm","peaceful","ambient"],tense:["suspense","tension","dramatic"],joyful:["uplifting","cheerful","happy"],adventure:["adventure","energetic","cinematic"],magical:["magical","fantasy","mystical"]}[e]||["ambient","instrumental"];return await this.searchTracks(s,t)}}class F{constructor(e){this.db=e,this.cache=new M,this.aiProcessor=new I,this.musicAPI=new L,this.bookAnalysis=null,this.chapterMappings={},this.availableTracks=[],this.eventHandlers={},this.currentBookId=null,this.chapters=[]}async initialize(e,t){this.currentBookId=e,this.chapters=t,await this.loadTracksFromAPI(),await this.verifyCaching(),console.log("ü§ñ AI analyzing book for mood-based music selection...");const a={id:e,title:"Current Book",chapters:t};this.bookAnalysis=await this.aiProcessor.analyzeBook(a),this.aiProcessor.generateChapterMappings(a,this.bookAnalysis.chapterAnalyses,this.availableTracks).forEach(r=>{this.chapterMappings[r.chapterId]=r}),console.log(`‚úì AI analysis complete. Book mood: ${this.bookAnalysis.bookProfile.dominantMood}`),console.log(`‚ô™ Available tracks: ${this.availableTracks.length}`)}onChapterChange(e){var r,n;if(console.log("üìñ onChapterChange called:",e),console.log("   Book analysis:",!!this.bookAnalysis),console.log("   Chapters:",(r=this.chapters)==null?void 0:r.length),!this.bookAnalysis||!this.chapters[e]){console.log("‚ö†Ô∏è Missing analysis or chapter");return}const t=this.chapters[e],a=this.bookAnalysis.chapterAnalyses[e],s=this.chapterMappings[t.id||t.title];console.log("   Chapter:",t.title),console.log("   Analysis:",a==null?void 0:a.primaryMood),console.log("   Mapping:",s==null?void 0:s.trackTitle),a&&s?(console.log(`üéµ Chapter ${e+1}: ${a.primaryMood} mood detected`),console.log(`   ${s.trackCount} tracks queued: ${((n=s.tracks)==null?void 0:n.map(o=>o.trackTitle).join(", "))||"None"}`),console.log(`   Energy: ${a.energy}/5 | Tags: ${a.musicTags.join(", ")}`),console.log("üì° Emitting chapterMusicChanged event"),console.log("   Event handlers:",this.eventHandlers),this.emit("chapterMusicChanged",{chapterIndex:e,analysis:a,recommendedTracks:s.tracks||[]}),console.log("‚úì Event emitted")):console.log("‚ö†Ô∏è Missing analysis or mapping")}async getTracksForChapter(e,t){const s=(await this.db.getMappingsByBook(e.id)).find(r=>r.chapterId===t.id);return s!=null&&s.trackIds?(await Promise.all(s.trackIds.map(n=>this.db.getTrack(n)))).filter(n=>n!==void 0):this._selectDefaultTracks(3)}_selectDefaultTracks(e){return[...this.defaultTracks].sort(()=>Math.random()-.5).slice(0,e)}async cacheTrack(e){try{console.log(`üíæ Caching track: ${e.title} (${e.id})`);const t=await fetch(e.url);if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.blob();await this.cache.cacheTrack(e.id,a),e.cached=!0,await this.db.addTrack(e),console.log(`‚úÖ Track cached successfully: ${e.title}`)}catch(t){console.error(`‚ùå Failed to cache track ${e.title}:`,t),e.cached=!1}}async verifyCaching(){console.log("üîç Verifying track caching status...");let e=0,t=this.availableTracks.length;for(const a of this.availableTracks)await this.cache.isTrackCached(a.id)?(e++,a.cached=!0):(a.cached=!1,a.popularity>80&&(console.log(`üì• Pre-caching popular track: ${a.title}`),await this.cacheTrack(a),e++));console.log(`üíæ Cache Status: ${e}/${t} tracks cached (${Math.round(e/t*100)}%)`),e<t*.5?console.warn("‚ö†Ô∏è Less than 50% of tracks are cached. Consider pre-caching for better performance."):console.log("‚úÖ Good caching coverage for smooth playback!")}async getAllAvailableTracks(){return this.availableTracks.length===0&&await this.loadTracksFromAPI(),this.availableTracks}async loadTracksFromAPI(){console.log("üéº MusicManager: Starting track loading...");try{if(!localStorage.getItem("freesound_api_key")){console.warn("‚ö†Ô∏è No API key configured. Music features disabled."),console.log("üîë Get a free API key from: https://freesound.org/apiv2/apply/"),this.availableTracks=[];return}console.log("‚úì Using Freesound API");const t=["calm","epic","romantic","mysterious","adventure","dark","tense","joyful","peaceful","magical"];console.log("üéµ Fetching tracks for",t.length,"moods:",t.join(", "));for(const a of t)try{console.log(`   Fetching ${a} tracks...`);const s=await this.musicAPI.getTracksForMood(a,15);console.log(`   ‚úì Got ${s.length} ${a} tracks`),this.availableTracks.push(...s)}catch(s){console.warn(`   ‚ùå Could not fetch ${a} tracks:`,s)}if(console.log("üìä Total tracks loaded:",this.availableTracks.length),this.availableTracks.length===0)console.warn("‚ö†Ô∏è No tracks loaded from API."),console.log("üí° Tip: Try adjusting your search tags or check API status");else{const a=new Set;this.availableTracks=this.availableTracks.filter(s=>a.has(s.id)?!1:(a.add(s.id),!0)),console.log(`‚úì Loaded ${this.availableTracks.length} unique music tracks`),console.log("   Track IDs:",this.availableTracks.map(s=>s.id).join(", "))}}catch(e){console.error("Error loading tracks from API:",e),this.availableTracks=[...this.defaultTracks]}}getChapterAnalysis(e){var t;return(t=this.bookAnalysis)==null?void 0:t.chapterAnalyses[e]}getBookProfile(){var e;return(e=this.bookAnalysis)==null?void 0:e.bookProfile}on(e,t){this.eventHandlers||(this.eventHandlers={}),this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t)}emit(e,t){var a;(a=this.eventHandlers)!=null&&a[e]&&this.eventHandlers[e].forEach(s=>s(t))}}class ${constructor(e){this.db=e,this.parser=new B,this.aiProcessor=new I,this.musicManager=new F(e),this.currentBook=null,this.currentChapterIndex=0,this.chapters=[],this.currentPage=1,this.currentPageInChapter=1,this.totalPages=0,this.pagesPerChapter={},this._isTurningPage=!1,this._pageGapPx=48,this._musicInitPromise=null,this._layoutChangedHandler=null,this._chapterLayoutToken=0,this._scrollUpdateTimer=null,this._progressSaveTimer=null,this._viewportEl=null,this._boundViewportScrollHandler=null}async openBook(e){try{console.log("üìñ Opening book with ID:",e),this.showLoading("Loading book...");const t=await this.db.getBook(e);if(!t||!t.downloadUrl)throw new Error("Book data or download URL not found");console.log("‚úÖ Book found:",t.title);const a=await fetch(t.downloadUrl);if(!a.ok)throw new Error(`Failed to fetch EPUB: ${a.statusText}`);const s=await a.arrayBuffer();console.log("üìÑ Parsing EPUB data...");const r=await this.parser.parse(s);console.log("‚úÖ EPUB parsed, chapters:",r.chapters.length);let n=await this.db.getAnalysis(e);if(n)console.log("‚úì Using cached AI analysis from database");else{console.log("‚ö†Ô∏è Book not analyzed yet. Running AI analysis...");const i={id:e,title:t.title,chapters:r.chapters};n=await this.aiProcessor.analyzeBook(i),await this.db.saveAnalysis(e,n),console.log("‚úì AI analysis complete and saved")}const o={id:t.id,title:t.title,author:t.author,currentChapter:t.currentChapter||0,currentPageInChapter:t.currentPageInChapter||1,chapters:r.chapters,downloadUrl:t.downloadUrl};console.log("üíæ Storing book data in sessionStorage..."),sessionStorage.setItem("currentBook",JSON.stringify(o)),this.hideLoading(),console.log("üîÑ Navigating to reader page..."),window.location.href="./reader.html"}catch(t){throw console.error("‚ùå Error opening book:",t),this.hideLoading(),this.showToast("Error opening book: "+t.message,"error"),t}}async initializeReader(){console.log("üîç Initializing reader...");const e=sessionStorage.getItem("currentBook");if(console.log("üìñ Book data from sessionStorage:",e?"Found":"Not found"),!e){console.warn("‚ùå No book data found, redirecting to library"),alert("No book selected. Redirecting to library..."),window.location.href="./index.html";return}try{const t=JSON.parse(e);console.log("üìö Parsed book data:",t.title),this.currentBook={id:t.id,title:t.title,author:t.author},this.chapters=t.chapters;let a=await this.db.getBook(t.id);this.currentChapterIndex=(a==null?void 0:a.currentChapter)??t.currentChapter??0,this.currentPageInChapter=(a==null?void 0:a.currentPageInChapter)??t.currentPageInChapter??1,this.pagesPerChapter={},this.currentPage=1,this.totalPages=0;const s=document.getElementById("book-title");if(!s)throw new Error("book-title element not found");s.textContent=t.title,console.log("üìã Rendering chapter list..."),this.renderChapterList(),console.log("üìÑ Loading chapter:",this.currentChapterIndex),await this.loadChapter(this.currentChapterIndex,{pageInChapter:this.currentPageInChapter,preservePage:!0}),console.log("‚ö° Setting up event listeners..."),this.setupEventListeners(),console.log("üéµ Initializing music manager (async)..."),this._musicInitPromise=this.musicManager.initialize(t.id,this.chapters).then(()=>console.log("‚úì Music manager ready")).catch(r=>console.warn("Music manager init failed:",r)),console.log("‚úÖ Reader initialized successfully")}catch(t){console.error("‚ùå Error initializing reader:",t),alert("Failed to load book: "+t.message),window.location.href="./index.html"}}renderChapterList(){const e=document.getElementById("chapter-list");e&&(e.innerHTML=this.chapters.map((t,a)=>{const s=this.musicManager.getChapterAnalysis(a),r=this.getMoodEmoji(s==null?void 0:s.primaryMood),n=s!=null&&s.primaryMood?`${r} ${s.primaryMood}`:"";return`
        <div class="chapter-item ${a===this.currentChapterIndex?"active":""}" 
             data-chapter="${a}">
          <span class="chapter-number">${a+1}</span>
          <div class="chapter-info">
            <span class="chapter-title">${this.escapeHtml(t.title)}</span>
            ${n?`<span class="chapter-mood">${n}</span>`:""}
          </div>
        </div>
      `}).join(""),e.querySelectorAll(".chapter-item").forEach(t=>{t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const s=parseInt(a.currentTarget.dataset.chapter);this.loadChapter(s)})}))}getMoodEmoji(e){return{dark:"üåë",mysterious:"üîç",romantic:"‚ù§Ô∏è",sad:"üò¢",epic:"‚öîÔ∏è",peaceful:"‚òÆÔ∏è",tense:"‚ö°",joyful:"üòä",adventure:"üèùÔ∏è",magical:"‚ú®"}[e]||"üéµ"}async loadChapter(e,{pageInChapter:t=1,preservePage:a=!1}={}){var o;if(e<0||e>=this.chapters.length)return;this.currentChapterIndex=e,this.currentPageInChapter=a?Math.max(1,t):1;const s=this.chapters[e],r=++this._chapterLayoutToken,n=document.getElementById("reader-content");if(n){n.innerHTML=`
        <div class="page-container">
          <div class="page-viewport">
            <div class="chapter-text">
              <h2 class="chapter-heading">${this.escapeHtml(s.title)}</h2>
              ${s.content}
            </div>
          </div>
        </div>
      `,this._ensureViewportScrollHandler(),await this._repaginateAndRender({waitForImages:!0}),this._updateNavButtons();try{(o=document.fonts)!=null&&o.ready&&document.fonts.ready.then(()=>{this._chapterLayoutToken===r&&this._repaginateAndRender({waitForImages:!1}).then(()=>this._updateNavButtons())})}catch{}n.querySelectorAll("a").forEach(i=>{i.addEventListener("click",c=>{const l=i.getAttribute("href");if(!(l&&l.startsWith("#"))){if(l&&!l.startsWith("http")){c.preventDefault();const h=this.findChapterByHref(l);h!==-1&&this.loadChapter(h);return}l&&(l.startsWith("http")||l.startsWith("//"))&&(c.preventDefault(),console.log("External link blocked:",l))}})})}document.getElementById("current-chapter").textContent=e+1,document.getElementById("total-chapters").textContent=this.chapters.length,document.querySelectorAll(".chapter-item").forEach((i,c)=>{i.classList.toggle("active",c===e)}),this._updateNavButtons(),await this.saveProgress(),this.musicManager&&this.musicManager.onChapterChange(e)}_ensureViewportScrollHandler(){const e=document.querySelector(".page-viewport");e&&(this._viewportEl===e&&this._boundViewportScrollHandler||(this._viewportEl&&this._boundViewportScrollHandler&&this._viewportEl.removeEventListener("scroll",this._boundViewportScrollHandler),this._boundViewportScrollHandler||(this._boundViewportScrollHandler=()=>{window.clearTimeout(this._scrollUpdateTimer),this._scrollUpdateTimer=window.setTimeout(()=>this._syncCurrentPageFromScroll(),60)}),this._viewportEl=e,e.addEventListener("scroll",this._boundViewportScrollHandler,{passive:!0})))}_updateNavButtons(){const e=document.getElementById("prev-chapter"),t=document.getElementById("next-chapter");if(!e&&!t)return;const a=this.pagesPerChapter[this.currentChapterIndex]||1,s=this.currentChapterIndex===0&&this.currentPageInChapter<=1,r=this.currentChapterIndex===this.chapters.length-1&&this.currentPageInChapter>=a;e&&(e.disabled=s),t&&(t.disabled=r)}findChapterByHref(e){const t=e.split("/").pop().split("#")[0];for(let a=0;a<this.chapters.length;a++){const s=this.chapters[a];if(s.href&&s.href.includes(t))return a;const r=t.match(/chapter[-_]?(\d+)/i);if(r&&parseInt(r[1])===a+1)return a}return-1}_getPageMetrics(){const e=this.getCurrentPageWidth(),t=document.getElementById("reader-content");let a=0;if(t){const o=window.getComputedStyle(t),i=parseFloat(o.paddingLeft)||0,c=parseFloat(o.paddingRight)||0;a=Math.max(0,Math.floor(t.clientWidth-i-c))}const s=a>0?Math.min(e,a):e,r=Math.max(200,window.innerHeight-200),n=this._pageGapPx;return{pageWidth:s,pageHeight:r,pageGap:n}}_getViewportPageStridePx(e){const{pageHeight:t}=this._getPageMetrics(),a=(e==null?void 0:e.closest(".page-viewport"))||document.querySelector(".page-viewport"),s=a?a.clientHeight:0,r=s>0?s:t,n=this._getLineHeightPx(e);return n>4&&Number.isFinite(n)?Math.max(1,Math.floor(r/n))*n:r}_getLineHeightPx(e){if(!e)return 0;const t=window.getComputedStyle(e),a=parseFloat(t.fontSize)||16;if(!t.lineHeight||t.lineHeight==="normal")return a*1.2;const s=parseFloat(t.lineHeight);return Number.isFinite(s)?s>0&&s<4?s*a:s:a*1.2}async _repaginateAndRender({waitForImages:e}={waitForImages:!0}){const t=document.querySelector(".chapter-text");if(!t)return;const{pageWidth:a,pageGap:s}=this._getPageMetrics();document.documentElement.style.setProperty("--page-width",`${a}px`),t.style.setProperty("--page-width",`${a}px`),t.style.setProperty("--page-gap",`${s}px`),document.querySelectorAll(".page-viewport").forEach(i=>{i.style.setProperty("--page-width",`${a}px`)}),await this._waitForContentLayout(t,{waitForImages:e});const r=this._getViewportPageStridePx(t),n=t.scrollHeight,o=Math.max(1,Math.ceil(n/r));this.pagesPerChapter[this.currentChapterIndex]=o,this.currentPageInChapter>o&&(this.currentPageInChapter=o),this._applyPageOffset(),this.currentPage=this.calculateCurrentPageNumber(),this.totalPages=this.calculateTotalPages(),this.updatePageIndicator()}async _waitForContentLayout(e,{waitForImages:t}={waitForImages:!0}){var a;try{if((a=document.fonts)!=null&&a.ready){const s=t?2500:800;await Promise.race([document.fonts.ready,new Promise(r=>setTimeout(r,s))])}}catch{}if(t){const s=Array.from(e.querySelectorAll("img"));s.length&&await Promise.race([Promise.allSettled(s.map(r=>r.complete?Promise.resolve():new Promise(n=>{r.addEventListener("load",n,{once:!0}),r.addEventListener("error",n,{once:!0})}))),new Promise(r=>setTimeout(r,700))])}await new Promise(s=>requestAnimationFrame(()=>s())),await new Promise(s=>requestAnimationFrame(()=>s()))}_applyPageOffset(){const e=document.querySelector(".chapter-text");if(!e)return;const t=e.closest(".page-viewport")||document.querySelector(".page-viewport");if(!t)return;const a=this._getViewportPageStridePx(e),s=(this.currentPageInChapter-1)*a;t.scrollTo({top:s,behavior:"auto"})}_scrollToPage(e,{behavior:t="smooth"}={}){const a=document.querySelector(".chapter-text"),s=(a==null?void 0:a.closest(".page-viewport"))||document.querySelector(".page-viewport");if(!s||!a)return;const r=this.pagesPerChapter[this.currentChapterIndex]||1,n=Math.max(1,Math.min(r,e)),o=this._getViewportPageStridePx(a),i=(n-1)*o;n!==this.currentPageInChapter&&(this.currentPageInChapter=n,this.currentPage=this.calculateCurrentPageNumber(),this.updatePageIndicator(),this._updateNavButtons()),s.scrollTo({top:i,behavior:t}),window.clearTimeout(this._progressSaveTimer),this._progressSaveTimer=window.setTimeout(()=>{this._syncCurrentPageFromScroll()},250)}_syncCurrentPageFromScroll(){const e=document.querySelector(".chapter-text"),t=(e==null?void 0:e.closest(".page-viewport"))||document.querySelector(".page-viewport");if(!t||!e)return;const a=this._getViewportPageStridePx(e),s=this.pagesPerChapter[this.currentChapterIndex]||1,r=Math.floor((t.scrollTop+a*.5)/a)+1,n=Math.max(1,Math.min(s,r));n!==this.currentPageInChapter&&(this.currentPageInChapter=n,this.currentPage=this.calculateCurrentPageNumber(),this.updatePageIndicator(),this._updateNavButtons()),window.clearTimeout(this._progressSaveTimer),this._progressSaveTimer=window.setTimeout(()=>{this.saveProgress().catch(()=>{})},400)}calculateCurrentPageNumber(){let e=1;for(let t=0;t<this.currentChapterIndex;t++)e+=this.pagesPerChapter[t]||1;return e+=this.currentPageInChapter-1,e}calculateTotalPages(){let e=0;for(let t=0;t<this.chapters.length;t++)e+=this.pagesPerChapter[t]||1;return e}updatePageIndicator(){let e=document.querySelector(".page-indicator");e||(e=document.createElement("div"),e.className="page-indicator",document.body.appendChild(e)),e.textContent=`Page ${this.currentPage} of ${this.totalPages}`}async saveProgress(){if(!this.currentBook)return;const e=this.totalPages>0?this.currentPage/this.totalPages*100:0;await this.db.updateBook(this.currentBook.id,{currentChapter:this.currentChapterIndex,currentPageInChapter:this.currentPageInChapter,progress:e});try{const t=sessionStorage.getItem("currentBook");if(t){const a=JSON.parse(t);(a==null?void 0:a.id)===this.currentBook.id&&(a.currentChapter=this.currentChapterIndex,a.currentPageInChapter=this.currentPageInChapter,sessionStorage.setItem("currentBook",JSON.stringify(a)))}}catch{}}scrollPage(e){const t=document.querySelector(".chapter-text"),a=(t==null?void 0:t.closest(".page-viewport"))||document.querySelector(".page-viewport");if(!a||!t)return;this._ensureViewportScrollHandler();const s=this._getViewportPageStridePx(t),r=Math.max(0,a.scrollHeight-a.clientHeight),n=4;if(e==="down"){if(a.scrollTop>=r-n){this.currentChapterIndex<this.chapters.length-1&&this.goToNextChapter();return}a.scrollBy({top:s,behavior:"smooth"})}else{if(a.scrollTop<=n){this.currentChapterIndex>0&&this.goToPreviousChapter();return}a.scrollBy({top:-s,behavior:"smooth"})}window.clearTimeout(this._scrollUpdateTimer),this._scrollUpdateTimer=window.setTimeout(()=>this._syncCurrentPageFromScroll(),120)}goToNextPage(){const e=this.pagesPerChapter[this.currentChapterIndex]||1;this.currentPageInChapter>=e||this._scrollToPage(this.currentPageInChapter+1,{behavior:"smooth"})}goToPreviousPage(){this.currentPageInChapter<=1||this._scrollToPage(this.currentPageInChapter-1,{behavior:"smooth"})}goToNextChapter(){this.currentChapterIndex>=this.chapters.length-1||(this.currentPageInChapter=1,this.loadChapter(this.currentChapterIndex+1,{pageInChapter:1,preservePage:!0}))}goToPreviousChapter(){if(this.currentChapterIndex<=0)return;const e=this.currentChapterIndex-1;this.loadChapter(e,{pageInChapter:Number.MAX_SAFE_INTEGER,preservePage:!0})}setupEventListeners(){var e,t,a;if((e=document.getElementById("prev-chapter"))==null||e.addEventListener("click",s=>{s.preventDefault(),this.scrollPage("up")}),(t=document.getElementById("next-chapter"))==null||t.addEventListener("click",s=>{s.preventDefault(),this.scrollPage("down")}),document.addEventListener("keydown",s=>{s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA"||(s.key==="ArrowLeft"||s.key==="ArrowUp"?(s.preventDefault(),this.scrollPage("up")):s.key==="ArrowRight"||s.key==="ArrowDown"?(s.preventDefault(),this.scrollPage("down")):(s.key==="f"||s.key==="F")&&(s.preventDefault(),this.toggleFullscreen()))}),(a=document.getElementById("fullscreen-btn"))==null||a.addEventListener("click",s=>{s.preventDefault(),this.toggleFullscreen()}),document.addEventListener("fullscreenchange",()=>this.updateFullscreenButton()),document.addEventListener("webkitfullscreenchange",()=>this.updateFullscreenButton()),this._ensureViewportScrollHandler(),document.addEventListener("visibilitychange",()=>{document.hidden&&this.saveProgress().catch(()=>{})}),window.addEventListener("beforeunload",()=>{this.saveProgress().catch(()=>{})}),!this._layoutChangedHandler){let s=!1;this._layoutChangedHandler=()=>{s||(s=!0,requestAnimationFrame(async()=>{s=!1,await this._repaginateAndRender({waitForImages:!1}),this._updateNavButtons()}))},window.addEventListener("reader:layoutChanged",this._layoutChangedHandler)}}toggleFullscreen(){if(!document.fullscreenElement&&!document.webkitFullscreenElement){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}else document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}updateFullscreenButton(){const e=document.getElementById("fullscreen-btn");if(e){const t=document.fullscreenElement||document.webkitFullscreenElement;e.textContent="‚õ∂",e.title=t?"Exit Fullscreen (F11)":"Fullscreen (F11)"}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showLoading(e){const t=document.getElementById("loading-overlay"),a=document.getElementById("loading-message");t&&a&&(a.textContent=e,t.classList.remove("hidden"))}hideLoading(){const e=document.getElementById("loading-overlay");e&&e.classList.add("hidden")}showToast(e,t="success"){const a=document.getElementById("toast-container");if(!a)return;const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,a.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}getCurrentPageWidth(){try{const e=JSON.parse(localStorage.getItem("booksWithMusic-settings"));return(e==null?void 0:e.pageWidth)||650}catch{return 650}}}class H{constructor(e){this.db=e;const t=window.matchMedia("(prefers-color-scheme: dark)").matches;this.settings={theme:t?"dark":"light",fontSize:16,lineHeight:1.6,fontFamily:"serif",textAlign:"left",pageWidth:650,brightness:100,pageColor:t?"black":"white",pageWarmth:0,showProgress:!0,showChapterTitle:!0,musicEnabled:!0,autoPlay:!1,crossfadeDuration:3},this._layoutChangeTimer=null}async initialize(){await this.loadSettings(),this.setupEventListeners(),this.applySettings()}setupEventListeners(){var m,y,f,k,b,C,P,v,E,x;(m=document.getElementById("settings-btn"))==null||m.addEventListener("click",d=>{d.preventDefault(),this.showSettings()}),(y=document.getElementById("close-settings"))==null||y.addEventListener("click",d=>{d.preventDefault(),this.hideSettings()}),(f=document.getElementById("theme-select"))==null||f.addEventListener("change",d=>{this.settings.theme=d.target.value,this.applyTheme(),this.saveSettings()});const e=document.getElementById("font-size"),t=document.getElementById("font-size-value");e==null||e.addEventListener("input",d=>{this.settings.fontSize=parseInt(d.target.value),t&&(t.textContent=`${this.settings.fontSize}px`),this.applyFontSize(),this.saveSettings()});const a=document.getElementById("line-height"),s=document.getElementById("line-height-value");a==null||a.addEventListener("input",d=>{this.settings.lineHeight=parseFloat(d.target.value),s&&(s.textContent=this.settings.lineHeight.toFixed(1)),this.applyLineHeight(),this.saveSettings(),this._emitLayoutChanged("lineHeight")}),(k=document.getElementById("font-family"))==null||k.addEventListener("change",d=>{this.settings.fontFamily=d.target.value,this.applyFontFamily(),this.saveSettings(),this._emitLayoutChanged("fontFamily")}),(b=document.getElementById("text-align"))==null||b.addEventListener("change",d=>{this.settings.textAlign=d.target.value,this.applyTextAlign(),this.saveSettings(),this._emitLayoutChanged("textAlign")});const r=document.getElementById("page-width"),n=document.getElementById("page-width-value");r==null||r.addEventListener("input",d=>{this.settings.pageWidth=parseInt(d.target.value),n&&(n.textContent=`${this.settings.pageWidth}px`),this.applyPageWidth(),this.saveSettings(),this._emitLayoutChanged("pageWidth")});const o=document.getElementById("brightness"),i=document.getElementById("brightness-value");o==null||o.addEventListener("input",d=>{this.settings.brightness=parseInt(d.target.value),i&&(i.textContent=`${this.settings.brightness}%`),this.applyBrightness(),this.saveSettings()}),(C=document.getElementById("page-color"))==null||C.addEventListener("change",d=>{this.settings.pageColor=d.target.value,this.applyPageColor(),this.saveSettings()});const c=document.getElementById("page-warmth"),l=document.getElementById("page-warmth-value");c==null||c.addEventListener("input",d=>{this.settings.pageWarmth=parseInt(d.target.value),l&&(l.textContent=`${this.settings.pageWarmth}%`),this.applyPageWarmth(),this.saveSettings()}),(P=document.getElementById("show-progress"))==null||P.addEventListener("change",d=>{this.settings.showProgress=d.target.checked,this.applyShowProgress(),this.saveSettings()}),(v=document.getElementById("show-chapter-title"))==null||v.addEventListener("change",d=>{this.settings.showChapterTitle=d.target.checked,this.applyShowChapterTitle(),this.saveSettings()});const h=document.getElementById("crossfade-duration"),u=document.getElementById("crossfade-value");h==null||h.addEventListener("input",d=>{this.settings.crossfadeDuration=parseInt(d.target.value),u&&(u.textContent=`${this.settings.crossfadeDuration}s`),this.saveSettings()}),(E=document.getElementById("music-enabled"))==null||E.addEventListener("change",d=>{this.settings.musicEnabled=d.target.checked,this.saveSettings()}),(x=document.getElementById("auto-play"))==null||x.addEventListener("change",d=>{this.settings.autoPlay=d.target.checked,this.saveSettings()});const g=document.getElementById("freesound-key"),p=document.getElementById("save-freesound-key");if(g){const d=localStorage.getItem("freesound_api_key");d&&(g.value=d)}p==null||p.addEventListener("click",d=>{d.preventDefault();const T=g==null?void 0:g.value.trim();T?(localStorage.setItem("freesound_api_key",T),this.showToast("Freesound API key saved! Reload to fetch music.","success")):this.showToast("Please enter a valid API key","error")})}showSettings(){const e=document.getElementById("settings-panel");e&&e.classList.add("show")}hideSettings(){const e=document.getElementById("settings-panel");e&&e.classList.remove("show")}async loadSettings(){const e=await this.db.getSetting("reader");if(e)try{this.settings={...this.settings,...e};let v=!1;(this.settings.autoPlay===void 0||this.settings.autoPlay===!0)&&(this.settings.autoPlay=!1,v=!0),this.settings.theme==="dark"&&this.settings.pageColor==="white"?(this.settings.pageColor="black",v=!0):this.settings.theme==="light"&&this.settings.pageColor==="black"?(this.settings.pageColor="white",v=!0):this.settings.theme==="sepia"&&(this.settings.pageColor==="white"||this.settings.pageColor==="black")&&(this.settings.pageColor="cream",v=!0),v&&this.saveSettings()}catch(v){console.error("Error loading settings:",v)}const t=document.getElementById("theme-select");t&&(t.value=this.settings.theme);const a=document.getElementById("font-size"),s=document.getElementById("font-size-value");a&&(a.value=this.settings.fontSize),s&&(s.textContent=`${this.settings.fontSize}px`);const r=document.getElementById("line-height"),n=document.getElementById("line-height-value");r&&(r.value=this.settings.lineHeight),n&&(n.textContent=this.settings.lineHeight.toFixed(1));const o=document.getElementById("font-family");o&&(o.value=this.settings.fontFamily);const i=document.getElementById("text-align");i&&(i.value=this.settings.textAlign);const c=document.getElementById("page-width"),l=document.getElementById("page-width-value");c&&(c.value=this.settings.pageWidth),l&&(l.textContent=`${this.settings.pageWidth}px`);const h=document.getElementById("brightness"),u=document.getElementById("brightness-value");h&&(h.value=this.settings.brightness),u&&(u.textContent=`${this.settings.brightness}%`);const g=document.getElementById("page-color");g&&(g.value=this.settings.pageColor);const p=document.getElementById("page-warmth"),m=document.getElementById("page-warmth-value");p&&(p.value=this.settings.pageWarmth??0),m&&(m.textContent=`${this.settings.pageWarmth??0}%`);const y=document.getElementById("show-progress");y&&(y.checked=this.settings.showProgress);const f=document.getElementById("show-chapter-title");f&&(f.checked=this.settings.showChapterTitle);const k=document.getElementById("crossfade-duration"),b=document.getElementById("crossfade-value");k&&(k.value=this.settings.crossfadeDuration),b&&(b.textContent=`${this.settings.crossfadeDuration}s`);const C=document.getElementById("music-enabled");C&&(C.checked=this.settings.musicEnabled);const P=document.getElementById("auto-play");P&&(P.checked=this.settings.autoPlay)}async saveSettings(){await this.db.saveSetting("reader",this.settings)}applySettings(){this.applyTheme(),this.applyFontSize(),this.applyLineHeight(),this.applyFontFamily(),this.applyTextAlign(),this.applyPageWidth(),this.applyBrightness(),this.applyPageColor(),this.applyPageWarmth(),this.applyShowProgress(),this.applyShowChapterTitle(),this._emitLayoutChanged("init")}applyTheme(){document.body.setAttribute("data-theme",this.settings.theme)}applyFontSize(){const e=`${this.settings.fontSize}px`;document.documentElement.style.setProperty("--reader-font-size",e),document.querySelectorAll(".chapter-text").forEach(t=>t.style.fontSize=e)}applyLineHeight(){const e=String(this.settings.lineHeight);document.documentElement.style.setProperty("--reader-line-height",e),document.querySelectorAll(".chapter-text").forEach(t=>t.style.lineHeight=e)}applyFontFamily(){const e={serif:'Georgia, "Times New Roman", serif',"sans-serif":'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',monospace:'"Courier New", Courier, monospace',"open-dyslexic":"OpenDyslexic, sans-serif"},t=e[this.settings.fontFamily]||e.serif;document.documentElement.style.setProperty("--reader-font-family",t),document.querySelectorAll(".chapter-text").forEach(a=>a.style.fontFamily=t)}applyTextAlign(){const e=this.settings.textAlign||"justify";document.documentElement.style.setProperty("--reader-text-align",e),document.querySelectorAll(".chapter-text").forEach(t=>t.style.setProperty("--reader-text-align",e))}applyPageWidth(){const e=`${this.settings.pageWidth}px`;document.documentElement.style.setProperty("--page-width",e),document.querySelectorAll(".chapter-text").forEach(t=>t.style.setProperty("--page-width",e)),document.querySelectorAll(".page-viewport").forEach(t=>t.style.setProperty("--page-width",e))}applyBrightness(){const e=document.getElementById("reader-view");e&&(e.style.filter=`brightness(${this.settings.brightness}%)`)}applyPageColor(){const e=document.getElementById("reader-view"),t=document.getElementById("reader-content"),a={white:{bg:"#ffffff",text:"#1c1e21"},cream:{bg:"#f9f6ed",text:"#3c3022"},gray:{bg:"#e8e8e8",text:"#1c1e21"},black:{bg:"#1a1a1a",text:"#e4e6eb"}},s=a[this.settings.pageColor]||a.white;document.documentElement.style.setProperty("--page-paper-base-bg",s.bg),document.documentElement.style.setProperty("--page-paper-text",s.text),e&&(e.style.backgroundColor=""),t&&(t.style.backgroundColor="",t.style.color=""),this.applyPageWarmth()}applyPageWarmth(){const e=Math.max(0,Math.min(100,this.settings.pageWarmth??0))/100,t=getComputedStyle(document.documentElement).getPropertyValue("--page-paper-base-bg").trim()||"#ffffff",s=this._blendColors(t,"#f2e3b2",e);document.documentElement.style.setProperty("--page-paper-bg",s)}_blendColors(e,t,a){const s=this._colorToRgb(e),r=this._colorToRgb(t);if(!s||!r)return e;const n=(l,h)=>Math.round(l+(h-l)*a),o=n(s.r,r.r),i=n(s.g,r.g),c=n(s.b,r.b);return`rgb(${o}, ${i}, ${c})`}_colorToRgb(e){const t=(e||"").trim(),a=t.match(/^#?([0-9a-f]{6})$/i);if(a){const r=parseInt(a[1],16);return{r:r>>16&255,g:r>>8&255,b:r&255}}const s=t.match(/^rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})(?:\s*,\s*(\d*(?:\.\d+)?)\s*)?\)$/i);return s?{r:Math.min(255,parseInt(s[1],10)),g:Math.min(255,parseInt(s[2],10)),b:Math.min(255,parseInt(s[3],10))}:null}_emitLayoutChanged(e){window.clearTimeout(this._layoutChangeTimer),this._layoutChangeTimer=window.setTimeout(()=>{window.dispatchEvent(new CustomEvent("reader:layoutChanged",{detail:{reason:e,settings:this.settings}}))},50)}applyShowProgress(){const e=document.querySelector(".reading-progress");e&&(e.style.display=this.settings.showProgress?"block":"none")}applyShowChapterTitle(){const e=document.getElementById("chapter-title");e&&(e.style.display=this.settings.showChapterTitle?"block":"none")}getSettings(){return{...this.settings}}showToast(e,t="success"){const a=document.getElementById("toast-container");if(!a)return;const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,a.appendChild(s),setTimeout(()=>s.classList.add("show"),10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}}class q{constructor(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.currentSource=null,this.nextSource=null,this.currentGain=this.audioContext.createGain(),this.nextGain=this.audioContext.createGain(),this.nextGain.gain.value=0,this.currentGain.connect(this.audioContext.destination),this.nextGain.connect(this.audioContext.destination),this.cacheManager=new M,this.eventHandlers={},this.state={playing:!1,trackIndex:0,volume:.7},this.crossfadeDuration=4}async playTrack(e){this.audioContext.state==="suspended"&&await this.audioContext.resume();const t=await this._loadTrack(e);this.currentSource?await this._crossfade(t):(this.currentSource=this._createSource(t,this.currentGain),this.currentSource.start()),this.state.playing=!0,this.state.currentTrack=e,this.emit("playing",e)}async preloadTrack(e){await this._loadTrack(e)}pause(){this.currentSource&&(this.audioContext.suspend(),this.state.playing=!1)}resume(){this.audioContext.resume(),this.state.playing=!0}stop(){this.currentSource&&(this.currentSource.stop(),this.currentSource=null),this.nextSource&&(this.nextSource.stop(),this.nextSource=null),this.state.playing=!1}setVolume(e){this.state.volume=Math.max(0,Math.min(1,e)),this.currentGain.gain.value=this.state.volume}setCrossfadeDuration(e){this.crossfadeDuration=e}getState(){return{...this.state}}async _loadTrack(e){const t=await this.cacheManager.getCachedTrack(e.id);let a;if(t)a=await t.arrayBuffer();else{const r=await(await fetch(e.url)).blob();await this.cacheManager.cacheTrack(e.id,r),a=await r.arrayBuffer()}return await this.audioContext.decodeAudioData(a)}_createSource(e,t){const a=this.audioContext.createBufferSource();return a.buffer=e,a.connect(t),a}async _crossfade(e){const t=this.audioContext.currentTime,a=this.crossfadeDuration;this.nextSource=this._createSource(e,this.nextGain),this.nextGain.gain.value=0,this.nextSource.start(t),this.currentGain.gain.linearRampToValueAtTime(0,t+a),this.nextGain.gain.linearRampToValueAtTime(this.state.volume,t+a),await new Promise(r=>setTimeout(r,a*1e3)),this.currentSource&&this.currentSource.stop(),this.currentSource=this.nextSource,this.nextSource=null;const s=this.currentGain;this.currentGain=this.nextGain,this.nextGain=s,this.nextGain.gain.value=0}async play(e){const t={url:e,id:e};await this.playTrack(t),this.emit("playing")}isPlaying(){return this.state.playing&&this.audioContext.state==="running"}on(e,t){this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t)}emit(e,t){this.eventHandlers[e]&&this.eventHandlers[e].forEach(a=>a(t))}}class z{constructor(e,t){this.db=e,this.musicManager=t,this.audioPlayer=new q,this.playlist=[],this.currentTrackIndex=0}initialize(){console.log("üéµ Initializing music panel..."),console.log("   Music manager:",!!this.musicManager),this.setupEventListeners(),this.setupMusicManagerListeners(),this.renderPlaylist(),console.log("‚úì Music panel initialized")}setupMusicManagerListeners(){if(console.log("üéß Setting up music manager listeners..."),!this.musicManager){console.warn("‚ö†Ô∏è No music manager available");return}console.log("‚úì Music manager available, registering listener"),this.musicManager.on("chapterMusicChanged",async e=>{console.log("üéµ Chapter music changed event received:",e),await this.loadPlaylistForChapter(e.chapterIndex,e.recommendedTracks);const a=JSON.parse(localStorage.getItem("booksWithMusic-settings")||"{}").autoPlay===!0;console.log("Auto-play enabled:",a),console.log("Playlist length:",this.playlist.length),console.log("Currently playing:",this.audioPlayer.state.playing),a?a&&this.playlist.length>0?(console.log("‚ñ∂Ô∏è Auto-playing recommended track..."),setTimeout(async()=>{await this.playTrack(0)},500)):console.log("‚ö†Ô∏è No tracks in playlist"):(console.log("‚è∏Ô∏è Auto-play disabled. Click play button to start music."),e.chapterIndex===0&&setTimeout(()=>{this.showToast("üéµ Click the play button to start music! (Requires Freesound API key - see Settings)","info")},1e3))})}async loadPlaylistForChapter(e,t){try{console.log("üéº Loading playlist for chapter:",e),console.log("   Recommended tracks:",(t==null?void 0:t.length)||0),console.log("   Fetching tracks from music manager...");const a=await this.musicManager.getAllAvailableTracks();if(console.log("‚úì Available tracks:",a.length),a.length===0){console.warn("No tracks available");return}if(t&&t.length>0){console.log(`Found ${t.length} recommended tracks for this chapter`);const s=[],r=new Set;for(const o of t){const i=a.find(c=>c.id===o.trackId);i&&(s.push(i),r.add(i.id),console.log(`   ${s.length}. ${i.title}`))}const n=a.filter(o=>!r.has(o.id));this.playlist=[...s,...n],console.log(`‚úì Playlist: ${s.length} chapter tracks + ${n.length} fallback tracks`)}else console.log("No specific recommendations, using all tracks"),this.playlist=a;this.currentTrackIndex=0,this.renderPlaylist(),console.log("Playlist loaded with",this.playlist.length,"tracks")}catch(a){console.error("Error loading playlist:",a)}}setupEventListeners(){var a,s,r,n,o;(a=document.getElementById("music-toggle"))==null||a.addEventListener("click",i=>{i.preventDefault(),this.togglePanel()}),(s=document.getElementById("close-music-panel"))==null||s.addEventListener("click",i=>{i.preventDefault(),this.hidePanel()}),(r=document.getElementById("play-pause"))==null||r.addEventListener("click",i=>{i.preventDefault(),this.togglePlayPause()}),(n=document.getElementById("prev-track"))==null||n.addEventListener("click",i=>{i.preventDefault(),this.previousTrack()}),(o=document.getElementById("next-track"))==null||o.addEventListener("click",i=>{i.preventDefault(),this.nextTrack()});const e=document.getElementById("volume-slider"),t=document.getElementById("volume-value");e==null||e.addEventListener("input",i=>{const c=parseInt(i.target.value);this.audioPlayer.setVolume(c/100),t&&(t.textContent=`${c}%`)}),this.audioPlayer.on("trackEnded",()=>{this.nextTrack()}),this.audioPlayer.on("playing",()=>{this.updatePlayPauseButton(!0)}),this.audioPlayer.on("paused",()=>{this.updatePlayPauseButton(!1)})}togglePanel(){const e=document.getElementById("music-panel");e&&e.classList.toggle("show")}hidePanel(){const e=document.getElementById("music-panel");e&&e.classList.remove("show")}renderPlaylist(){const e=document.getElementById("playlist-tracks");if(e){if(this.playlist.length===0){e.innerHTML='<p class="empty-playlist">No tracks available</p>';return}e.innerHTML=this.playlist.map((t,a)=>`
      <div class="playlist-item ${a===this.currentTrackIndex?"active":""}" 
           data-track-index="${a}">
        <span class="track-number">${a+1}</span>
        <div class="track-info">
          <div class="track-title">${this.escapeHtml(t.title)}</div>
          <div class="track-artist">${this.escapeHtml(t.artist||"Unknown")}</div>
        </div>
        <span class="track-duration">${this.formatDuration(t.duration)}</span>
      </div>
    `).join(""),e.querySelectorAll(".playlist-item").forEach(t=>{t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const s=parseInt(a.currentTarget.dataset.trackIndex);this.playTrack(s)})})}}async playTrack(e){if(e<0||e>=this.playlist.length)return;this.currentTrackIndex=e;const t=this.playlist[e];this.updateCurrentTrackInfo(t),this.updatePlaylistSelection();try{await this.audioPlayer.playTrack(t),console.log("‚ñ∂Ô∏è Now playing:",t.title)}catch(a){console.error("‚ùå Error playing track:",a),console.log("‚è≠Ô∏è Skipping to next track..."),e+1<this.playlist.length?setTimeout(()=>this.playTrack(e+1),1e3):(console.warn("‚ö†Ô∏è No more tracks to play"),localStorage.getItem("freesound_api_key")?this.showToast("‚ùå Unable to load music tracks. Please check your API key in Settings.","error"):this.showToast("üîë Music playback requires a free Freesound API key. Get one at freesound.org/apiv2/apply and add it in Settings.","error"))}}showToast(e,t="info"){const a=document.createElement("div");a.className=`toast toast-${t}`,a.textContent=e,a.style.cssText="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-secondary);color:var(--text-primary);padding:12px 24px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:90%;text-align:center;",document.body.appendChild(a),setTimeout(()=>a.remove(),5e3)}updateCurrentTrackInfo(e){const t=document.getElementById("current-track");t&&(t.innerHTML=`
        <div class="track-title">${this.escapeHtml(e.title)}</div>
        <div class="track-artist">${this.escapeHtml(e.artist||"Unknown")}</div>
      `)}updatePlaylistSelection(){document.querySelectorAll(".playlist-item").forEach((e,t)=>{e.classList.toggle("active",t===this.currentTrackIndex)})}togglePlayPause(){this.audioPlayer.isPlaying()?this.audioPlayer.pause():this.playlist.length>0&&this.playTrack(this.currentTrackIndex)}updatePlayPauseButton(e){const t=document.getElementById("play-pause");t&&(t.textContent=e?"‚è∏":"‚ñ∂Ô∏è")}previousTrack(){const e=this.currentTrackIndex-1;e>=0&&this.playTrack(e)}nextTrack(){const e=this.currentTrackIndex+1;e<this.playlist.length?this.playTrack(e):this.playTrack(0)}formatDuration(e){if(!e)return"0:00";const t=Math.floor(e/60),a=Math.floor(e%60);return`${t}:${a.toString().padStart(2,"0")}`}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class D{constructor(){this.db=new _,this.library=new A(this.db),this.reader=new $(this.db),this.settings=new H(this.db),this.musicPanel=null}async initialize(){try{console.log("üìö BooksWithMusic initializing..."),await this.db.initialize(),console.log("‚úì Database initialized"),window.location.pathname.includes("reader.html")?(console.log("üìñ Loading reader page..."),await this.reader.initializeReader(),this.settings.initialize(),this.musicPanel=new z(this.db,this.reader.musicManager),this.musicPanel.initialize(),console.log("‚úì Music panel ready"),console.log("üéµ Triggering initial chapter music..."),this.reader._musicInitPromise&&await this.reader._musicInitPromise,this.reader.musicManager.onChapterChange(this.reader.currentChapterIndex),console.log("‚úì Reader initialized")):(console.log("üè† Loading home page..."),await this.library.initialize(),console.log("‚úì Library initialized")),this.setupEventListeners(),await this.registerServiceWorker(),console.log("‚úì App ready!")}catch(e){console.error("‚ùå Initialization error:",e),alert("Failed to initialize app. Check console for details.")}}setupEventListeners(){document.body.addEventListener("click",e=>{e.target.closest("#back-to-library")&&(e.preventDefault(),this.showLibrary())}),this.library&&this.library.on&&this.library.on("bookSelected",e=>{console.log("üìö Book selected event received:",e),this.showReader(e)})}async showReader(e){console.log("üìñ Opening book with ID:",e);try{await this.reader.openBook(e)}catch(t){console.error("Error opening book:",t),alert("Failed to open book: "+t.message)}}showLibrary(){window.location.href="./index.html"}async registerServiceWorker(){var e,t,a,s,r;if((t=(e=import.meta)==null?void 0:e.env)!=null&&t.DEV){try{if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistrations();await Promise.all(n.map(o=>o.unregister()))}if((a=window.caches)!=null&&a.keys){const n=await window.caches.keys();await Promise.all(n.filter(o=>o.startsWith("booksWithMusic-")).map(o=>window.caches.delete(o)))}console.log("Dev mode: service worker disabled and caches cleared")}catch(n){console.warn("Dev mode: failed to clear service worker/caches:",n)}return}if("serviceWorker"in navigator)try{const o=(((r=(s=import.meta)==null?void 0:s.env)==null?void 0:r.BASE_URL)||"/")+"service-worker.js";await navigator.serviceWorker.register(o),console.log("Service Worker registered")}catch(n){console.warn("Service Worker registration failed:",n)}}}const W=new D;W.initialize().catch(console.error);
